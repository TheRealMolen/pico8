pico-8 cartridge // http://www.pico-8.com
version 27
__lua__
-- m a t h s ‚úΩ --


function pvec(v)
	print("("..v[1]..","..v[2]..")",7)
end
	

function dot(a,b)
	return a[1]*b[1] + a[2]*b[2]
end

function mag(v)
	return sqrt(v[1]*v[1] + v[2]*v[2])
end

function distsqr(a,b)
	local diff={b[1]-a[1], b[2]-a[2]}
	return dot(diff,diff)
end

function sqr(v)
	return v*v
end

function perp(p)
	return {p[2], -p[1]}
end

function lerpvec(a,b,t)
	return {
		a[1] + t * (b[1]-a[1]),
		a[2] + t * (b[2]-a[2])
	}
end

-- return the unit vector between two points
-- also returns the magnitude as the 3rd element
function getunitdir(x0,y0, x1,y1)
	if (x0==x1) and (y0==y1) then
		return {1,0}
	end
	
	local dx=x1-x0
	local dy=y1-y0
	local mag=sqrt(dx*dx + dy*dy)
	local udx=dx/mag
	local udy=dy/mag
	
	return {udx,udy, mag}
end

-- return the vec across capsule
function getperp(c)
	local udir=c[6]
	
	local n=perp(udir)
	
	return {n[1] * c[5],
							  n[2] * c[5]}
end

-- get nearest point on line to point
-- returns barycentric coord as 3rd element
--function nearestpoint(l, p)
--	-- get line seg unit dir
--	local ldir=getunitdir(l[1],l[2],l[3],l[4])
--	local len=ldir[3]
--	
--	-- get vec from lstart to p
--	local lpx=p[1]-l[1]
--	local lpy=p[2]-l[2]
--	
--	-- project
--	local t=dot(ldir, {lpx,lpy})
--	
--	if t <= 0 then
--		return {l[1],l[2], 0, ldir}
--	elseif t >= len then
--		return {l[3],l[4], 1, ldir}
--	end
--	
--	return {
--		l[1] + t*ldir[1],
--		l[2] + t*ldir[2],
--		t/len,
--		ldir
--	}
--end


-----------------------

function capsule(x0,y0, x1,y1, r)
	local udir=getunitdir(x0,y0, x1,y1)
	return {
		x0,y0,
		x1,y1,
		r,	-- .5=radius
		{udir[1],udir[2]}, -- .6=dir
		udir[3],	-- .7=length
	}
end

function isect_cap_sphere(c,s)
	local cdir=c[6]
	local clen=c[7]
	
	local csdx=s[1]-c[1]
	local csdy=s[2]-c[2]
	
	local t=dot(cdir, {csdx,csdy})
	
	-- find closest point on capsule line
	local nrst=nil
	if t <= 0 then
		nrst={c[1],c[2]}
	elseif t >= clen then
		nrst={c[3],c[4]}
	else
	 nrst={
			c[1] + t*cdir[1],
			c[2] + t*cdir[2]
		}
	end
	
	local cr=c[5]
	local sr=s[3]
	local dsq=distsqr(nrst, s)
	
	if dsq > sqr(cr+sr) then
		return nil -- no contact
	end
	
	local tang,norm
	if t >= 0 and t <= clen then
		-- simple case - bounce against line
		tang=cdir
		norm=perp(tang)		
	else
		-- bounce against sphere cap
		norm=getunitdir(nrst[1],nrst[2], s[1],s[2])
		tang=perp({-norm[1],-norm[2]})
	end
	
	return {tang, norm}
end
-->8
-- m a p ‚ñë --

static = {
	capsule(4,4, 124,4, 4),
	capsule(4,4, 4,128, 4),
	capsule(124,4, 124,128, 4),
	capsule(4,94, 124,128, 4),
	capsule(40,40, 70,70, 4),
}


function drawcapsule(c)
	circ(c[1],c[2], c[5], 11)
	circ(c[3],c[4], c[5], 11)
	
	p = getperp(c)
	line(c[1]+p[1], c[2]+p[2],
				  c[3]+p[1], c[4]+p[2],
				  7)
	line(c[1]-p[1], c[2]-p[2],
				  c[3]-p[1], c[4]-p[2],
				  7)
end

function drawmap()
	map(0,0, 0,0, 16,32)
	
	for c in all(static) do
		drawcapsule(c)
	end
end

-->8
-- b a l l ‚óÜ --

function newball(x,y)
	local b={}
	b.x=x b.y=y
	b.r=4
	b.vx=0.3 b.vy=2
	return b
end

function collidewithworld(b)
	local newpos={b.x+b.vx,b.y+b.vy}
	local sph={newpos[1], newpos[2], b.r}
	
	for c in all(static) do
		local contact=isect_cap_sphere(c, sph)
		if contact then
			local tang=contact[1]
			local norm=contact[2]
			
			local vel={b.vx,b.vy}
			local vt=dot(vel,tang)
			local vn=dot(vel,norm)
			vn = vn * -0.99
			
			b.vx = vt*tang[1] + vn*norm[1]
			b.vy = vt*tang[2] + vn*norm[2]
		end
	end
end

function updateball(b)
	collidewithworld(b)
	
	b.x += b.vx
	b.y += b.vy
end


function drawball(b)
	spr(1, b.x-b.r+1,b.y-b.r+1, 1,1)
end

-->8
-- m a i n üòê --

b = newball(60,20)

function _update60()
	updateball(b)
end

function drawnearestpoints(b)
	local bpos={b.x,b.y}
	for c in all(static) do
		local p = nearestpoint(c, bpos)
		circfill(p[1],p[2], 2, 8)
	end
end

function _draw()
	cls()
	drawmap()
	drawball(b)
	
--	drawnearestpoints(b)

	print((stat(1)*100).."% cpu", 94,2, 2)
	print((stat(7)).."fps", 94,10, 2)
end
__gfx__
00000000006665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000067666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700676666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000666666650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700666666650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000056666500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000005655000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44449494449494490000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44944444944494490000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44494494944494490000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444494944494440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444944444444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
49444944494444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
49444449494449440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44494449494449440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
444944444444449400000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
494944444944444400000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
494444444944444400000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
444449494494494400000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
944449444494444400000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
444944444444444900000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
449494944444444400000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
444494944494944900000000cccccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
2020202020202020202120202020202030313031303100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2031203030212131302121303031212020212021202100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2020203030202020202121302121212030313031303100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2020212130303020302020203030302020212021202100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2030212020212030302121212021202030313031303100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2021303130312030303130313031202020212021202100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2120202120212030202120302021202030312021202100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2020202120212021202120212021202020213031303100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2031303130313031303030313031202021212121202100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2121312120303031303030212021212121213021303100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2121202120302121202120202121212121212021202100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2131303130313031313131212131302130213031303120210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2121202120212021312121202121212121212021202130310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2121212130313031213030212121212130213021303100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2120213021212120212121212021212121212121202100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2130313031302121213030313031302131212121303100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3321202021202120212021212021203321203030202120210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3321302121302130213031313031303321303021303130310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3321303030212130213021302121213321202130202120210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3331303031312130313030303121303321213030303130310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333302021212120213021202120333321212030202100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2133333321213121313031303333333021303031303100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2120303033333333333333332130212121212121202120210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3130213021302121213031303121313030312130303130310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2120212121212120302130202120212120303030202120210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2130212131213130313021303130213121212121303130310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2121302121212130212021302120212121213021202100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3130213021303021313031212130212121213030213100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2120212021202120212121212121213030303021212120210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2121213021212121213130213121213121313030303130212100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2120302121202121212021202121202120212030202120212100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3130303031303130313031303131303130313030303130312100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000208200d6100d6100e6200e6200d6300d6300c6300c6300c6300c6300a63009630096200a6200b6300c6400e6400e6300e6300c6200c6300d6300e6300e6300c6300a6300b6200c6200d6300e6400e6300c630
000200002f66027620197000770021000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
